<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Maintenance Online Dashboard</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f1f5f9; 
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Mobile Card Style */
        .mobile-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 8px;
            margin-bottom: 4px;
        }

        .mobile-label { font-size: 11px; color: #94a3b8; text-transform: uppercase; font-weight: 600; }
        .mobile-value { font-size: 14px; font-weight: 500; color: #334155; }

        /* Animation */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="text-slate-800 pb-20">

    <!-- HEADER -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 px-4 py-3 shadow-sm safe-area-inset-top">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-green-600 text-white p-2 rounded-lg shadow-md shadow-green-100">
                    <i class="fab fa-google-drive text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold tracking-tight text-slate-800 leading-tight">Maintenance</h1>
                    <p class="text-[10px] text-slate-500 font-medium flex items-center gap-1">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Online (Google Sheet)
                    </p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <div class="bg-slate-100 p-1 rounded-lg flex items-center border border-slate-200">
                    <button onclick="switchView('desktop')" id="btn-desktop" class="p-1.5 rounded-md text-slate-400 hover:text-blue-600 transition-colors">
                        <i class="fas fa-table"></i>
                    </button>
                    <button onclick="switchView('mobile')" id="btn-mobile" class="p-1.5 rounded-md text-slate-400 hover:text-blue-600 transition-colors">
                        <i class="fas fa-th-list"></i>
                    </button>
                </div>
                <button onclick="loadDataFromUrl()" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-50 hover:bg-slate-100 border border-slate-200 text-slate-500 transition-colors" title="รีโหลดข้อมูล">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Year Selector -->
        <div class="container mx-auto mt-3 overflow-x-auto no-scrollbar pb-1">
            <div id="year-selector-container" class="flex gap-2 min-w-max px-1"></div>
        </div>
    </nav>

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-[60] flex flex-col items-center justify-center backdrop-blur-sm hidden">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-slate-200 border-t-green-600 mb-4"></div>
        <p class="text-slate-600 font-semibold animate-pulse text-sm">กำลังเชื่อมต่อ Google Sheets...</p>
    </div>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto p-4 space-y-6 mt-2">

        <!-- DASHBOARD AREA -->
        <div id="dashboard-view" class="space-y-5 fade-in hidden">
            
            <!-- --- NEW FILTER SECTION (MOVED TO TOP) --- -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <h3 class="font-bold text-slate-700 text-sm mb-3 flex items-center gap-2">
                    <i class="fas fa-filter text-slate-400"></i> ตัวกรองข้อมูล (Filters)
                </h3>
                <div class="flex flex-col md:flex-row gap-3">
                    <div class="flex gap-2 overflow-x-auto pb-1 md:pb-0 no-scrollbar flex-1">
                        <select id="locationFilter" onchange="filterLocationChanged()" class="text-xs bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 outline-none shadow-sm min-w-[120px] focus:ring-2 focus:ring-blue-500">
                            <option value="All">ทุกสถานที่</option>
                        </select>
                        <select id="machineFilter" onchange="filterTable()" class="text-xs bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 outline-none shadow-sm min-w-[120px] focus:ring-2 focus:ring-blue-500">
                            <option value="All">ทุกเครื่องจักร</option>
                        </select>
                        <select id="typeFilter" onchange="filterTable()" class="text-xs bg-slate-50 border border-slate-200 rounded-lg px-3 py-2.5 outline-none shadow-sm min-w-[100px] focus:ring-2 focus:ring-blue-500">
                            <option value="All">ทุกประเภท</option>
                            <option value="PM">PM</option>
                            <option value="BM">BM</option>
                        </select>
                    </div>
                    <div class="relative md:w-64">
                        <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-xs"></i>
                        <input type="text" id="searchBox" placeholder="ค้นหา (Issue, Remark)..." onkeyup="filterTable()" class="w-full text-xs bg-slate-50 border border-slate-200 rounded-lg pl-9 pr-3 py-2.5 outline-none shadow-sm focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-2"><span class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-wider">Budget</span><i class="fas fa-coins text-slate-300"></i></div>
                    <h3 id="kpi-budget" class="text-lg md:text-2xl font-bold text-slate-700">฿0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-2"><span class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-wider">Actual</span><i class="fas fa-receipt text-blue-300"></i></div>
                    <h3 id="kpi-actual" class="text-lg md:text-2xl font-bold text-blue-600">฿0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-2"><span class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-wider">Variance</span><i class="fas fa-chart-line text-emerald-300"></i></div>
                    <h3 id="kpi-variance" class="text-lg md:text-2xl font-bold text-emerald-600">฿0</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between">
                    <div class="flex justify-between items-start mb-2"><span class="text-[10px] md:text-xs font-bold text-slate-400 uppercase tracking-wider">Jobs</span><i class="fas fa-tools text-purple-300"></i></div>
                    <h3 id="kpi-jobs" class="text-lg md:text-2xl font-bold text-purple-600">0</h3>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                <div class="lg:col-span-2 bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-700 mb-4 text-xs md:text-sm flex items-center gap-2 uppercase tracking-wide">
                        <i class="far fa-chart-bar text-blue-500"></i> Monthly Trend
                    </h3>
                    <div class="h-48 md:h-72 w-full relative"><canvas id="mainChart"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-slate-700 mb-4 text-xs md:text-sm flex items-center gap-2 uppercase tracking-wide">
                        <i class="fas fa-chart-pie text-purple-500"></i> Job Type
                    </h3>
                    <div class="h-40 md:h-64 flex justify-center relative"><canvas id="pieChart"></canvas></div>
                </div>
            </div>

            <!-- Data List -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                        <i class="fas fa-list text-slate-400"></i> Transaction Logs
                    </h3>
                    <span id="record-count" class="text-xs text-slate-400">Loading...</span>
                </div>

                <!-- Desktop Table -->
                <div id="desktop-table-view" class="overflow-x-auto hidden">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0 shadow-sm">
                            <tr>
                                <th class="px-6 py-3 bg-slate-50">Date</th>
                                <th class="px-6 py-3 bg-slate-50">Machine</th>
                                <th class="px-6 py-3 bg-slate-50">Type</th>
                                <th class="px-6 py-3 bg-slate-50">Details</th>
                                <th class="px-6 py-3 bg-slate-50 text-right">Budget</th>
                                <th class="px-6 py-3 bg-slate-50 text-right">Actual</th>
                                <th class="px-6 py-3 bg-slate-50 text-right">Var</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>

                <!-- Mobile Cards -->
                <div id="mobile-card-view" class="p-4 space-y-3 bg-slate-50 hidden"></div>
                
                <div class="p-3 bg-white border-t border-slate-100 text-center">
                    <button onclick="showAllData()" class="text-xs text-blue-500 font-bold hover:underline">แสดงข้อมูลทั้งหมด</button>
                </div>
            </div>
        </div>
        
        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-20 px-6">
            <div class="bg-red-50 text-red-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 class="text-lg font-bold text-slate-700">ไม่สามารถดึงข้อมูลได้</h3>
            <p class="text-sm text-slate-500 mt-2">อาจเป็นเพราะปัญหา CORS หรือลิงก์ไม่ถูกต้อง<br>ลองรีโหลดหน้าเว็บ หรือตรวจสอบลิงก์ Google Sheet</p>
            <button onclick="location.reload()" class="mt-6 bg-slate-800 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg">ลองใหม่</button>
        </div>

    </main>

    <script>
        // CONFIG
        // ลิงก์ Google Sheet ที่คุณให้มา (แบบรวม Sheet ทั้งหมดไว้ใน Sheet เดียว)
        const DEFAULT_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTFI8SjwYbMa5nobhz0NzCFryV8Qdo7jWneLPDJeZCohSBUM5x1TYrO57ojtJPPM8JPyZqoqkfZFqgn/pub?output=csv";
        
        let rawData = [], yearsList = [], locMachineMap = {};
        let currentYear = null;
        let chartInstances = {}; 
        let currentView = 'mobile';
        let showLimit = 500; // เพิ่มจำนวนการแสดงผล

        // --- INIT ---
        window.onload = () => {
            // Auto-detect screen size
            if (window.innerWidth >= 768) switchView('desktop');
            else switchView('mobile');

            loadDataFromUrl(DEFAULT_URL);
        };

        function showAllData() {
            showLimit = 10000; // Show a lot
            filterTable();
        }

        // --- DATA LOADING ---
        function loadDataFromUrl(url = DEFAULT_URL) {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('error-state').classList.add('hidden');
            
            // Cache Buster
            const fetchUrl = url + '&t=' + new Date().getTime();

            Papa.parse(fetchUrl, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    if (results.data && results.data.length > 0) {
                        processData(results.data);
                        initDashboard();
                        document.getElementById('dashboard-view').classList.remove('hidden');
                    } else {
                        document.getElementById('error-state').classList.remove('hidden');
                    }
                    document.getElementById('loading-overlay').classList.add('hidden');
                },
                error: (err) => {
                    console.error(err);
                    document.getElementById('loading-overlay').classList.add('hidden');
                    document.getElementById('error-state').classList.remove('hidden');
                }
            });
        }

        function processData(json) {
            rawData = [];
            json.forEach(row => {
                let dateVal = row['Date'] || row['date'] || row['วันที่'];
                if (!dateVal) return;

                let dateObj;
                // Improved Date Parsing
                if (typeof dateVal === 'number') {
                    dateObj = new Date(Math.round((dateVal - 25569) * 86400 * 1000));
                } else {
                    const s = String(dateVal).trim();
                    if (s.includes('-')) {
                        // Handle YYYY-MM-DD
                        dateObj = new Date(s);
                    } else if (s.includes('/')) {
                        const p = s.split('/');
                        // Handle multiple formats: DD/MM/YYYY or MM/DD/YYYY
                        // Try DD/MM/YYYY first (common in Thailand)
                        if(p[0].length <= 2 && p[1].length <= 2 && p[2].length == 4) {
                             dateObj = new Date(p[2], p[1]-1, p[0]);
                        } else {
                             // Fallback to standard JS parsing
                             dateObj = new Date(s);
                        }
                    } else {
                        // Try generic parse
                        dateObj = new Date(s);
                    }
                }

                // If date is invalid, skip row
                if (!dateObj || isNaN(dateObj.getTime())) return;

                rawData.push({
                    year: dateObj.getFullYear(),
                    month: dateObj.getMonth(), // 0-11
                    dateStr: dateObj.toLocaleDateString('th-TH', {day:'2-digit', month:'2-digit', year:'2-digit'}),
                    rawDate: dateObj,
                    id: row['Machine_ID']||row['MachineID']||'-',
                    loc: row['Location']||row['location']||'-',
                    type: row['Job_Type']||row['Type']||'BM',
                    issue: row['Issue']||row['Description']||'-',
                    action: row['Action_Taken']||row['Action']||'-',
                    budget: parseFloat(row['Budget']||0),
                    actual: parseFloat(row['Actual']||row['Actual_Cost']||0),
                    variance: parseFloat(row['Variance']||((row['Budget']||0)-(row['Actual']||row['Actual_Cost']||0))),
                    remark: row['Remark']||''
                });
            });
        }

        // --- DASHBOARD LOGIC ---
        function initDashboard() {
            // Extract Years
            const uniqueYears = new Set(rawData.map(d => d.year));
            yearsList = Array.from(uniqueYears).sort((a, b) => a - b);

            // Extract Locations & Machines
            locMachineMap = {};
            const uniqueLocations = new Set();
            rawData.forEach(row => {
                if(row.loc !== '-') {
                    uniqueLocations.add(row.loc);
                    if(!locMachineMap[row.loc]) locMachineMap[row.loc] = new Set();
                    locMachineMap[row.loc].add(row.id);
                }
            });

            // Filters
            const locSelect = document.getElementById('locationFilter');
            locSelect.innerHTML = '<option value="All">ทุกสถานที่</option>';
            Array.from(uniqueLocations).sort().forEach(l => {
                const opt = document.createElement('option');
                opt.value = l; opt.innerText = l; locSelect.appendChild(opt);
            });
            updateMachineFilter('All');

            // Year Buttons
            const container = document.getElementById('year-selector-container');
            container.innerHTML = '';
            if (yearsList.length > 0) {
                yearsList.forEach(year => {
                    const btn = document.createElement('button');
                    btn.id = `btn-${year}`;
                    btn.className = "px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap bg-white border border-slate-200 text-slate-500 shadow-sm mr-2 hover:bg-slate-50 transition-colors";
                    btn.innerText = year;
                    btn.onclick = () => switchYear(year);
                    container.appendChild(btn);
                });
                // Select latest
                switchYear(yearsList[yearsList.length - 1]);
            }
        }

        // --- FILTER & RENDER ---
        function switchView(mode) {
            currentView = mode;
            const dtBtn = document.getElementById('btn-desktop');
            const mbBtn = document.getElementById('btn-mobile');
            const dView = document.getElementById('desktop-table-view');
            const mView = document.getElementById('mobile-card-view');

            if (mode === 'desktop') {
                dtBtn.classList.add('text-blue-600','bg-white','shadow-sm'); dtBtn.classList.remove('text-slate-400');
                mbBtn.classList.add('text-slate-400'); mbBtn.classList.remove('text-blue-600','bg-white','shadow-sm');
                dView.classList.remove('hidden'); mView.classList.add('hidden');
            } else {
                mbBtn.classList.add('text-blue-600','bg-white','shadow-sm'); mbBtn.classList.remove('text-slate-400');
                dtBtn.classList.add('text-slate-400'); dtBtn.classList.remove('text-blue-600','bg-white','shadow-sm');
                mView.classList.remove('hidden'); dView.classList.add('hidden');
            }
            filterTable();
        }

        function switchYear(year) {
            currentYear = year;
            yearsList.forEach(y => {
                const btn = document.getElementById(`btn-${y}`);
                if (btn) btn.className = y === year 
                    ? "px-4 py-1.5 rounded-full text-sm font-bold bg-green-600 text-white shadow-md transform scale-105 transition-all mr-2 border-transparent"
                    : "px-4 py-1.5 rounded-full text-sm font-medium bg-white border border-slate-200 text-slate-500 shadow-sm hover:bg-slate-50 mr-2";
            });
            renderDashboard();
        }

        function filterLocationChanged() {
            updateMachineFilter(document.getElementById('locationFilter').value);
            renderDashboard();
        }

        function updateMachineFilter(loc) {
            const select = document.getElementById('machineFilter');
            select.innerHTML = '<option value="All">ทุกเครื่องจักร</option>';
            let machines = new Set();
            if(loc === 'All') rawData.forEach(r => { if(r.id) machines.add(r.id); });
            else if(locMachineMap[loc]) machines = locMachineMap[loc];
            
            Array.from(machines).sort().forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.innerText = m; select.appendChild(opt);
            });
            select.value = 'All';
        }

        function filterTable() { renderDashboard(); }

        function renderDashboard() {
            const locVal = document.getElementById('locationFilter').value;
            const macVal = document.getElementById('machineFilter').value;
            const typeVal = document.getElementById('typeFilter').value;
            const searchVal = document.getElementById('searchBox').value.toLowerCase();

            const filtered = rawData.filter(d => {
                return d.year === currentYear &&
                       (locVal === 'All' || d.loc === locVal) &&
                       (macVal === 'All' || d.id === macVal) &&
                       (typeVal === 'All' || d.type === typeVal) &&
                       ((d.id.toLowerCase().includes(searchVal)) || (d.issue.toLowerCase().includes(searchVal)));
            });

            // KPIs
            const budget = filtered.reduce((s,i)=>s+i.budget,0);
            const actual = filtered.reduce((s,i)=>s+i.actual,0);
            const variance = filtered.reduce((s,i)=>s+i.variance,0);

            document.getElementById('kpi-budget').innerText = formatMoney(budget);
            document.getElementById('kpi-actual').innerText = formatMoney(actual);
            const vEl = document.getElementById('kpi-variance');
            vEl.innerText = (variance>0?'+':'') + formatMoney(variance);
            vEl.className = `text-lg md:text-2xl font-bold ${variance>=0?'text-emerald-600':'text-red-500'}`;
            document.getElementById('kpi-jobs').innerText = filtered.length;
            document.getElementById('record-count').innerText = `${filtered.length} รายการ`;

            renderCharts(filtered);
            renderLists(filtered);
        }

        function renderLists(data) {
            // Increase limit from 100 to 500
            const sorted = data.sort((a,b)=>b.rawDate-a.rawDate).slice(0, showLimit); 
            
            // Desktop Table
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            sorted.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-50 transition-colors";
                const varColor = row.variance >= 0 ? 'text-emerald-600' : 'text-red-600';
                tr.innerHTML = `
                    <td class="px-6 py-3 whitespace-nowrap text-slate-500">${row.dateStr}</td>
                    <td class="px-6 py-3 font-bold text-slate-700">${row.id}</td>
                    <td class="px-6 py-3"><span class="px-2 py-1 rounded-md text-xs font-bold ${row.type==='PM'?'bg-emerald-100 text-emerald-700':'bg-red-100 text-red-700'}">${row.type}</span></td>
                    <td class="px-6 py-3"><div class="font-medium text-slate-700">${row.issue}</div><div class="text-xs text-slate-400">${row.action}</div></td>
                    <td class="px-6 py-3 text-right text-slate-400">${formatMoney(row.budget)}</td>
                    <td class="px-6 py-3 text-right font-bold text-slate-700">${formatMoney(row.actual)}</td>
                    <td class="px-6 py-3 text-right font-bold text-xs ${varColor}">${formatMoney(row.variance)}</td>
                `;
                tbody.appendChild(tr);
            });

            // Mobile Cards
            const cardContainer = document.getElementById('mobile-card-view');
            cardContainer.innerHTML = '';
            sorted.forEach(row => {
                const varColor = row.variance >= 0 ? 'text-emerald-600' : 'text-red-600';
                const typeColor = row.type === 'PM' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700';
                cardContainer.innerHTML += `
                    <div class="mobile-card border-l-4 ${row.type==='PM'?'border-l-emerald-500':'border-l-red-500'}">
                        <div class="mobile-card-header">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold ${typeColor} px-2 py-0.5 rounded">${row.type}</span>
                                <span class="font-bold text-slate-700 text-sm">${row.id}</span>
                            </div>
                            <span class="text-xs text-slate-400">${row.dateStr}</span>
                        </div>
                        <div class="mb-3">
                            <div class="text-sm font-medium text-slate-700">${row.issue}</div>
                            <div class="text-xs text-slate-500 truncate">${row.action}</div>
                        </div>
                        <div class="grid grid-cols-3 gap-1 pt-2 border-t border-slate-50">
                            <div><div class="mobile-label">Budget</div><div class="mobile-value text-slate-400">${formatMoney(row.budget)}</div></div>
                            <div class="text-right"><div class="mobile-label">Actual</div><div class="mobile-value text-slate-700 font-bold">${formatMoney(row.actual)}</div></div>
                            <div class="text-right"><div class="mobile-label">Var</div><div class="mobile-value ${varColor} font-bold">${(row.variance>0?'+':'')+formatMoney(row.variance)}</div></div>
                        </div>
                    </div>`;
            });
        }

        // --- CHARTS ---
        function renderCharts(data) {
            const mActual = new Array(12).fill(0);
            const mBudget = new Array(12).fill(0);
            let pm = 0, bm = 0;

            data.forEach(d => {
                mActual[d.month] += d.actual;
                mBudget[d.month] += d.budget;
                if (d.type.toUpperCase() === 'PM') pm++; else bm++;
            });

            const ctxMain = document.getElementById('mainChart').getContext('2d');
            if(chartInstances.main) chartInstances.main.destroy();
            chartInstances.main = new Chart(ctxMain, {
                type: 'bar',
                data: {
                    labels: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],
                    datasets: [{ label:'Bud', data:mBudget, backgroundColor:'#cbd5e1', borderRadius:4 }, { label:'Act', data:mActual, backgroundColor:'#3b82f6', borderRadius:4 }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{boxWidth:10}}} }
            });

            const ctxPie = document.getElementById('pieChart').getContext('2d');
            if(chartInstances.pie) chartInstances.pie.destroy();
            chartInstances.pie = new Chart(ctxPie, {
                type: 'doughnut',
                data: { labels: ['PM','BM'], datasets: [{ data:[pm,bm], backgroundColor:['#10b981','#ef4444'], borderWidth:0 }] },
                options: { responsive:true, maintainAspectRatio:false, cutout:'70%', plugins:{legend:{position:'right', labels:{boxWidth:10}}} }
            });
        }

        const formatMoney = (n) => '฿' + n.toLocaleString('th-TH', {maximumFractionDigits:0});
    </script>
</body>
</html>

import React, { useState, useMemo, useEffect } from 'react';
import { 
  AlertTriangle, Clock, FileText, Database, Settings, 
  Car, ChevronRight, X, AlertCircle, CheckCircle, 
  List, Search, RefreshCw, WifiOff, Edit3, Save, Calendar
} from 'lucide-react';

// --- üîΩ Web App URL üîΩ ---
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxXGEJJ6YFD9Bfk0b6QF1iL_b48tRuKuz7BFrDe38HUeVH41wlZaulRHyFEKAjNEJi_/exec"; 

// --- Utility Functions ---

const parseDate = (dateStr) => {
  if (!dateStr) return null;
  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Date Object ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
  if (dateStr instanceof Date) return dateStr;
  
  let targetDate;
  const str = String(dateStr).trim();

  // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô dd/mm/yyyy (‡πÄ‡∏ä‡πà‡∏ô 31/12/2567)
  if (str.includes('/')) {
    const parts = str.split('/');
    if (parts.length === 3) {
      const day = parts[0].padStart(2, '0');
      const month = parts[1].padStart(2, '0');
      let year = parseInt(parts[2]);
      if (year > 2400) year -= 543; // ‡πÅ‡∏õ‡∏•‡∏á ‡∏û.‡∏®. -> ‡∏Ñ.‡∏®.
      targetDate = new Date(`${year}-${month}-${day}`);
    }
  } else {
    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô
    targetDate = new Date(str);
  }
  return targetDate;
}

const getDaysRemaining = (dateStr) => {
  const targetDate = parseDate(dateStr);
  if (!targetDate || isNaN(targetDate.getTime())) return -99999;

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  targetDate.setHours(0, 0, 0, 0);
  const diffTime = targetDate - today;
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
};

const formatDateThai = (dateStr) => {
  const date = parseDate(dateStr);
  if (!date || isNaN(date.getTime())) return String(dateStr); // ‡∏ñ‡πâ‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡πÇ‡∏ä‡∏ß‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (Debug)
  return date.toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
};

const formatDateForInput = (dateStr) => {
  const date = parseDate(dateStr);
  if (!date || isNaN(date.getTime())) return "";
  return date.toISOString().split('T')[0];
};

// --- Components ---

const DashboardCard = ({ title, icon: Icon, expiredCount, warningCount, totalCount, type, onClick }) => {
  const theme = {
    insurance: { gradient: "bg-gradient-to-r from-blue-600 to-indigo-600", shadow: "shadow-blue-200", iconBg: "bg-white/20" },
    tax: { gradient: "bg-gradient-to-r from-orange-500 to-amber-500", shadow: "shadow-orange-200", iconBg: "bg-white/20" },
    all: { gradient: "bg-gradient-to-r from-slate-700 to-slate-800", shadow: "shadow-slate-200", iconBg: "bg-white/20" }
  }[type] || { gradient: "bg-gray-500", shadow: "", iconBg: "" }; 

  return (
    <button 
      onClick={onClick}
      disabled={totalCount === 0}
      className={`relative w-full overflow-hidden rounded-3xl shadow-xl ${theme.shadow} transition-all duration-300 transform hover:scale-[1.02] active:scale-95 group bg-white border border-gray-100 disabled:opacity-50 disabled:cursor-not-allowed`}
    >
      <div className={`${theme.gradient} p-5 text-white relative overflow-hidden`}>
        <div className="relative z-10 flex justify-between items-start">
          <div className="flex items-center gap-3">
            <div className={`p-2.5 rounded-xl backdrop-blur-md ${theme.iconBg} border border-white/20`}>
              <Icon size={26} className="text-white" />
            </div>
            <div className="text-left">
              <h3 className="text-lg font-bold tracking-wide opacity-95">{title}</h3>
              <p className="text-xs text-white/80 font-light">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</p>
            </div>
          </div>
          <div className="bg-white/20 p-1.5 rounded-full backdrop-blur-sm">
            <ChevronRight size={18} className="text-white" />
          </div>
        </div>
      </div>

      <div className="p-5">
        {type === 'all' ? (
           <div className="flex items-center justify-between">
              <div>
                <p className="text-xs text-gray-400 font-medium uppercase tracking-wider mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                <p className="text-5xl font-black text-slate-700 tracking-tighter">{totalCount}</p>
              </div>
              <Car size={64} className="text-slate-100 absolute right-4 bottom-4" />
           </div>
        ) : (
          <div className="flex gap-4">
            <div className={`flex-1 rounded-2xl p-3 border border-red-100 bg-red-50 relative overflow-hidden`}>
              {expiredCount > 0 && <span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}
              <div className="flex items-center gap-1.5 mb-1 text-red-600 text-xs font-bold uppercase tracking-wide">
                <AlertCircle size={12} /> ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
              </div>
              <p className={`text-3xl font-black ${expiredCount > 0 ? 'text-red-600' : 'text-gray-300'}`}>
                {expiredCount}
              </p>
            </div>

            <div className={`flex-1 rounded-2xl p-3 border border-yellow-100 bg-yellow-50`}>
              <div className="flex items-center gap-1.5 mb-1 text-yellow-700 text-xs font-bold uppercase tracking-wide">
                <Clock size={12} /> ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î
              </div>
              <p className={`text-3xl font-black ${warningCount > 0 ? 'text-yellow-700' : 'text-gray-300'}`}>
                {warningCount}
              </p>
            </div>
          </div>
        )}
      </div>
    </button>
  );
};

const EditModal = ({ car, onClose, onSave, isSaving }) => {
  const [formData, setFormData] = useState({
    insurance_expire: formatDateForInput(car.insurance_expire),
    tax_expire: formatDateForInput(car.tax_expire)
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(car.plate, formData);
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose} />
      <div className="bg-white rounded-2xl w-full max-w-sm p-6 relative z-10 shadow-2xl animate-in zoom-in-95 duration-200">
        <h3 className="text-xl font-bold mb-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <p className="text-gray-500 text-sm mb-6">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: <span className="font-bold text-slate-800">{car.plate}</span></p>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢</label>
            <div className="relative">
              <input 
                type="date" 
                required
                className="w-full p-3 pl-10 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                value={formData.insurance_expire}
                onChange={e => setFormData({...formData, insurance_expire: e.target.value})}
              />
              <Calendar className="absolute left-3 top-3.5 text-slate-400" size={18}/>
            </div>
          </div>

          <div>
            <label className="block text-xs font-bold text-gray-400 uppercase mb-1">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏†‡∏≤‡∏©‡∏µ</label>
            <div className="relative">
              <input 
                type="date" 
                required
                className="w-full p-3 pl-10 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none"
                value={formData.tax_expire}
                onChange={e => setFormData({...formData, tax_expire: e.target.value})}
              />
              <Calendar className="absolute left-3 top-3.5 text-slate-400" size={18}/>
            </div>
          </div>

          <div className="flex gap-3 mt-6">
            <button type="button" onClick={onClose} className="flex-1 py-3 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button 
              type="submit" 
              disabled={isSaving}
              className="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-black transition flex items-center justify-center gap-2 disabled:opacity-70"
            >
              {isSaving ? <RefreshCw className="animate-spin" size={18}/> : <Save size={18}/>}
              {isSaving ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

const DetailModal = ({ category, data, allCarsData, onClose, onEditCar }) => {
  const [activeTab, setActiveTab] = useState('expired');
  const [searchTerm, setSearchTerm] = useState("");
  const themeBg = category === 'insurance' ? 'bg-blue-600' : category === 'tax' ? 'bg-orange-600' : 'bg-slate-700';

  // Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î All
  if (category === 'all') {
    const filteredAll = allCarsData.filter(c => c.plate.toLowerCase().includes(searchTerm.toLowerCase()));
    return (
      <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose} />
        <div className="bg-white/95 backdrop-blur-xl w-full sm:max-w-md h-[90vh] sm:h-[85vh] rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden relative z-10 transition-transform animate-in slide-in-from-bottom duration-300">
          <div className="p-5 bg-white border-b border-gray-100 flex justify-between items-center sticky top-0 z-10 shadow-sm">
            <div>
              <h2 className="text-xl font-black text-slate-800 flex items-center gap-2">
                <List className="text-slate-600"/> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              </h2>
              <p className="text-xs text-slate-400 mt-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô {allCarsData.length} ‡∏Ñ‡∏±‡∏ô</p>
            </div>
            <button onClick={onClose} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 transition"><X size={20} className="text-slate-600"/></button>
          </div>
          <div className="p-4 bg-slate-50 border-b border-slate-100">
            <div className="relative">
              <Search className="absolute left-3 top-3 text-gray-400" size={16} />
              <input type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô..." className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-slate-400 text-sm bg-white" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
            </div>
          </div>
          <div className="overflow-y-auto flex-1 p-4 bg-slate-50/50 space-y-3 pb-20">
            {filteredAll.map((car, index) => {
              const insDays = getDaysRemaining(car.insurance_expire);
              const taxDays = getDaysRemaining(car.tax_expire);
              return (
                <div key={index} className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition-shadow">
                  <div className="flex items-center gap-3">
                    <div className="bg-slate-100 p-2 rounded-lg text-slate-500"><Car size={20} /></div>
                    <div>
                      <div className="font-bold text-gray-800 text-base">{car.plate}</div>
                      <div className="flex gap-2 text-[10px] uppercase font-bold tracking-wider text-gray-400 mt-0.5">
                         <span className={insDays < 0 ? "text-red-500" : ""}>‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô {formatDateThai(car.insurance_expire)}</span>
                         <span>‚Ä¢</span>
                         <span className={taxDays < 0 ? "text-red-500" : ""}>‡∏†‡∏≤‡∏©‡∏µ {formatDateThai(car.tax_expire)}</span>
                      </div>
                    </div>
                  </div>
                  <button onClick={() => onEditCar(car)} className="p-2 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100"><Edit3 size={16}/></button>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    );
  }

  // Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î Insurance / Tax
  const safeData = data || [];
  const expiredList = safeData.filter(d => d.days < 0);
  const warningList = safeData.filter(d => d.days >= 0 && d.days <= 30);
  const currentList = (activeTab === 'expired' ? expiredList : warningList).filter(item => item.plate.toLowerCase().includes(searchTerm.toLowerCase()));
  const getThemeTitle = () => category === 'insurance' ? '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå' : '‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå';

  return (
    <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
      <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={onClose} />
      <div className="bg-white/95 backdrop-blur-xl w-full sm:max-w-md h-[90vh] sm:h-[85vh] rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden relative z-10 transition-transform animate-in slide-in-from-bottom duration-300">
        <div className={`p-6 pb-8 text-white ${themeBg} relative overflow-hidden shadow-lg`}>
          <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/3 blur-2xl"></div>
          <div className="relative z-10 flex justify-between items-center">
            <div>
              <h2 className="text-2xl font-black flex items-center gap-2 tracking-tight">
                {category === 'insurance' ? <FileText size={24}/> : <Database size={24}/>}
                {getThemeTitle()}
              </h2>
              <p className="text-white/80 text-sm font-light mt-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</p>
            </div>
            <button onClick={onClose} className="p-2 bg-white/20 backdrop-blur-md rounded-full hover:bg-white/30 transition shadow-inner"><X size={20} /></button>
          </div>
        </div>
        <div className="px-4 -mt-6 relative z-20 space-y-3">
          <div className="bg-white p-1.5 rounded-xl shadow-lg border border-gray-100 flex">
            <button onClick={() => setActiveTab('expired')} className={`flex-1 py-2.5 text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'expired' ? 'bg-red-50 text-red-600 shadow-sm ring-1 ring-red-100' : 'text-gray-400 hover:bg-gray-50'}`}>
              <AlertCircle size={16} className={activeTab === 'expired' ? 'animate-pulse' : ''} /> ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ <span className="bg-white px-1.5 rounded text-xs ml-1 shadow-sm border">{expiredList.length}</span>
            </button>
            <button onClick={() => setActiveTab('warning')} className={`flex-1 py-2.5 text-sm font-bold rounded-lg flex items-center justify-center gap-2 transition-all duration-300 ${activeTab === 'warning' ? 'bg-yellow-50 text-yellow-700 shadow-sm ring-1 ring-yellow-100' : 'text-gray-400 hover:bg-gray-50'}`}>
              <Clock size={16} /> ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î <span className="bg-white px-1.5 rounded text-xs ml-1 shadow-sm border">{warningList.length}</span>
            </button>
          </div>
          <div className="relative shadow-sm rounded-xl">
            <Search className="absolute left-3 top-3 text-gray-400" size={16} />
            <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ..." className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-slate-300 text-sm bg-white" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
          </div>
        </div>
        <div className="overflow-y-auto flex-1 p-4 bg-slate-50/50 space-y-3 mt-2 pb-20">
          {currentList.length === 0 ? (
            <div className="flex flex-col items-center justify-center h-48 text-gray-300">
              <div className="bg-gray-100 p-4 rounded-full mb-3"><CheckCircle size={40} className="text-gray-300" /></div>
              <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            </div>
          ) : (
            currentList.map((item, index) => (
              <div key={index} className="bg-white/80 backdrop-blur-sm p-4 rounded-2xl flex justify-between items-center hover:shadow-lg transition-all duration-300 border border-white">
                <div>
                  <div className="flex items-center gap-2"><span className="text-lg font-black text-slate-700 tracking-tight">{item.plate}</span></div>
                  <div className="text-sm text-gray-500 flex items-center gap-1 mt-1"><span className="font-medium bg-gray-100 px-2 py-0.5 rounded text-xs">{formatDateThai(item.expireDate)}</span></div>
                </div>
                <div className="flex items-center gap-2">
                   <div className={`px-4 py-2 rounded-xl text-xs font-bold shadow-sm border ${item.days < 0 ? 'bg-red-500 text-white border-red-400' : 'bg-yellow-400 text-yellow-900 border-yellow-300'}`}>{item.days < 0 ? `‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(item.days)} ‡∏ß‡∏±‡∏ô` : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.days} ‡∏ß‡∏±‡∏ô`}</div>
                   <button onClick={() => onEditCar(allCarsData.find(c => c.plate === item.plate))} className="p-2 text-gray-400 hover:text-blue-600 bg-white rounded-lg border border-gray-200"><Edit3 size={16}/></button>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </div>
  );
};

// --- Main App ---

export default function FleetManagerV7_Racer() {
  const [cars, setCars] = useState([]); 
  const [selectedCategory, setSelectedCategory] = useState(null); 
  const [showSettings, setShowSettings] = useState(false);
  const [scriptUrl, setScriptUrl] = useState(APPS_SCRIPT_URL);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [editingCar, setEditingCar] = useState(null);
  const [isSaving, setIsSaving] = useState(false);

  const stats = useMemo(() => {
    const insuranceData = cars.map(c => ({ plate: c.plate, expireDate: c.insurance_expire, days: getDaysRemaining(c.insurance_expire) }));
    const taxData = cars.map(c => ({ plate: c.plate, expireDate: c.tax_expire, days: getDaysRemaining(c.tax_expire) }));
    return {
      insurance: { expired: insuranceData.filter(d => d.days < 0).length, warning: insuranceData.filter(d => d.days >= 0 && d.days <= 30).length, data: insuranceData },
      tax: { expired: taxData.filter(d => d.days < 0).length, warning: taxData.filter(d => d.days >= 0 && d.days <= 30).length, data: taxData }
    };
  }, [cars]);

  // Fetch Data
  const fetchSheetData = async (url) => {
    const targetUrl = url || scriptUrl;
    if (!targetUrl) return;
    
    setLoading(true);
    setError(null);
    try {
      // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Apps Script ‡∏ó‡∏µ‡πà deploy ‡πÅ‡∏ö‡∏ö Anyone)
      const response = await fetch(targetUrl);
      
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Response OK ‡πÑ‡∏´‡∏°
      if (!response.ok) {
        throw new Error(`HTTP Error: ${response.status} (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Permission ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 'Anyone' ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á)`);
      }
      
      // ‡∏•‡∏≠‡∏á Parse JSON
      let jsonData;
      try {
         jsonData = await response.json();
      } catch (jsonErr) {
         const text = await response.text();
         // ‡∏ñ‡πâ‡∏≤ Response ‡πÄ‡∏õ‡πá‡∏ô HTML (‡∏°‡∏±‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Login Google) ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤ Permission ‡∏ú‡∏¥‡∏î
         if (text.includes("<!DOCTYPE html>") || text.includes("Google Accounts")) {
            throw new Error("‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (Permission Denied) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Deploy ‡πÄ‡∏õ‡πá‡∏ô 'Anyone'");
         }
         throw new Error("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (Not JSON)");
      }

      if (!Array.isArray(jsonData) || jsonData.length === 0) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠ Format ‡∏ú‡∏¥‡∏î");

      setCars(jsonData);
      setShowSettings(false);
    } catch (error) {
      console.error(error);
      setCars([]); 
      setError(error.message);
    } finally {
      setLoading(false);
    }
  };

  // Save Data
  const handleSaveCar = async (plate, updatedData) => {
    if (!scriptUrl) return;
    setIsSaving(true);
    try {
      await fetch(scriptUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ plate, ...updatedData })
      });
      const newCars = cars.map(c => c.plate === plate ? { ...c, ...updatedData } : c);
      setCars(newCars);
      setEditingCar(null); 
    } catch (err) {
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
    } finally {
      setIsSaving(false);
    }
  };

  useEffect(() => {
    if (APPS_SCRIPT_URL) fetchSheetData(APPS_SCRIPT_URL);
  }, []);

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900 relative overflow-hidden">
      {/* Background Decor */}
      <div className="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div className="absolute top-[-50px] left-[-50px] w-96 h-96 bg-red-200 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
        <div className="absolute top-[20%] right-[-50px] w-96 h-96 bg-yellow-200 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style={{animationDelay: '1s'}}></div>
      </div>
      
      <header className="p-6 flex justify-between items-center max-w-lg mx-auto relative z-10">
        <div>
          <h1 className="text-2xl font-black text-slate-800 tracking-tighter flex items-center gap-2">
            <span className="text-red-600 italic transform -skew-x-12" style={{ fontFamily: 'Impact, sans-serif' }}>Racer</span> 
            <span className="text-slate-700">‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</span>
          </h1>
          <p className="text-slate-500 text-xs font-medium uppercase tracking-widest mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</p>
        </div>
        <button onClick={() => setShowSettings(true)} className="p-2.5 bg-white rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition text-slate-600 active:scale-95"><Settings size={20} /></button>
      </header>

      <main className="px-5 pb-10 max-w-lg mx-auto space-y-6 relative z-10">
        {error && (
            <div className="bg-red-50 border border-red-200 rounded-2xl p-6 text-center animate-in fade-in slide-in-from-top-4">
                <div className="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><WifiOff size={32} className="text-red-500" /></div>
                <h3 className="text-lg font-bold text-red-700 mb-2">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</h3>
                <p className="text-red-600 text-sm mb-2">{error}</p>
                <div className="text-xs text-red-500 bg-white/50 p-2 rounded mb-4">
                  ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ: ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Apps Script &gt; Manage Deployments &gt; Edit &gt; Who has access = <strong>Anyone</strong>
                </div>
                <button onClick={() => setShowSettings(true)} className="px-6 py-2 bg-red-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-red-200 hover:bg-red-700 transition">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL</button>
            </div>
        )}

        {!error && cars.length === 0 && !loading && (
            <div className="bg-white/80 backdrop-blur border border-slate-200 rounded-3xl p-8 text-center shadow-xl">
                <div className="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce"><Database size={32} className="text-blue-500" /></div>
                <h3 className="text-xl font-bold text-slate-800 mb-2">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <p className="text-slate-500 text-sm mb-6">‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                <button onClick={() => fetchSheetData()} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg hover:bg-slate-900 transition">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ</button>
            </div>
        )}

        {loading && (
            <div className="flex flex-col items-center justify-center py-20">
                <RefreshCw size={40} className="text-blue-600 animate-spin mb-4" />
                <p className="text-slate-500 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        )}

        {cars.length > 0 && (
            <>
                <DashboardCard title="‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏†‡∏±‡∏¢‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå" type="insurance" icon={FileText} expiredCount={stats.insurance.expired} warningCount={stats.insurance.warning} totalCount={cars.length} onClick={() => setSelectedCategory('insurance')} />
                <DashboardCard title="‡∏†‡∏≤‡∏©‡∏µ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå" type="tax" icon={Database} expiredCount={stats.tax.expired} warningCount={stats.tax.warning} totalCount={cars.length} onClick={() => setSelectedCategory('tax')} />
                <DashboardCard title="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" type="all" icon={List} totalCount={cars.length} onClick={() => setSelectedCategory('all')} />
            </>
        )}
      </main>

      {selectedCategory && (
        <DetailModal 
          category={selectedCategory}
          data={selectedCategory !== 'all' ? stats[selectedCategory].data : []}
          allCarsData={cars}
          onClose={() => setSelectedCategory(null)}
          onEditCar={setEditingCar} 
        />
      )}

      {editingCar && (
        <EditModal 
          car={editingCar} 
          onClose={() => setEditingCar(null)} 
          onSave={handleSaveCar}
          isSaving={isSaving}
        />
      )}

      {showSettings && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" onClick={() => setShowSettings(false)}></div>
          <div className="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl relative z-10 transform transition-all scale-100">
            <h2 className="text-xl font-bold mb-4 text-slate-800">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API</h2>
            <div className="space-y-4">
              <div>
                <label className="text-xs font-bold text-gray-400 mb-2 block uppercase tracking-wide">Google Apps Script URL</label>
                <input value={scriptUrl} onChange={(e) => setScriptUrl(e.target.value)} className="w-full border p-3 rounded-xl text-sm mb-3 focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50 text-slate-600" placeholder="https://script.google.com/..." />
                <button onClick={() => fetchSheetData()} disabled={loading} className="w-full bg-slate-800 text-white p-3 rounded-xl text-sm font-bold hover:bg-slate-900 transition shadow-lg shadow-slate-200 flex items-center justify-center gap-2">
                  {loading ? <RefreshCw size={16} className="animate-spin"/> : '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà'}
                </button>
              </div>
            </div>
            <button onClick={() => setShowSettings(false)} className="mt-4 w-full text-gray-400 text-sm hover:text-gray-600">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
          </div>
        </div>
      )}
    </div>
  );
}
